<HTML>

<HEAD>  

  <TITLE>Qt Audio Input</TITLE>

  <meta charset="UTF-8">
  <meta name="description" content="Audio input in a Qt application with plotting of the waveform. ">
  <meta name="keywords" content="Qt, Audio, Input, Sampling, QBuffer, QAudioInput, QMultimedia">
  <meta name="author" content="Bo Joel Svensson">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="canonical" href="https://svenssonjoel.github.io/pages/qt-audio-input/index.html" />

</HEAD> 

<style type="text/css">
  
  body, html {
  margin-left: 5%;
  margin-right: 5%;
  }
  
  
  .topnav {
  overflow: auto;
  white-space: nowrap;
  background-color: #333;
  }
  
  .topnav a {
  display: inline-block;
  color: #f2f2f2;
  text-align: center;
  padding: 14px 16px;
  text-decoration: none;
  font-size: 17px;
  }
  
  .topnav a:hover {
  background-color: #ddd;
  color: black;
  }
  
  .topnav a.active {
  background-color: #4CAF50;
  color: white;
  }
  
  
  .hero-image {
  background-image: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url("../../images/nerd.jpg");
  height: 50%;  
  /* Position and center the image to scale nicely on all screens */
  background-position: center;
  background-repeat: no-repeat;
  background-size: cover;
  position: relative;
  }

  /* Place text in the middle of the image */
  .hero-text {
  text-align: center;
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  color: gray;
  }
  
  
  
  body, html {
  margin-left: 5%;
  margin-right: 5%;
  font-size: large;
  zoom-level: 150%;
  }
  
  pre {
  background-color: white;
  word-wrap: normal;
  overflow-x: auto;
  white-space: pre;
  margin-left: 2%;
  margin-right: 2%;
  }

  img {
  max-width:100%;
  height:auto;
  }

  embed {
  max-width:100%;
  width:100%;
  min-height:350px;
  height:auto;
  }
 
  .yt-link {
  text-align: center;
  }
  
  .yt-link img {
  display: block;
  margin: 0 auto;
  max-width: 100%
  }

  tr:hover {background-color: #8abd8a;}
  

  th {
  background-color: #333;
  color: white;
  }
  
</style>

<BODY bgcolor=#C0C0C0>

<div class="hero-image">
 <div class="hero-text">
   <h1>BLOG</h1>
 </div>
</div>   

<div class="topnav">
  <a href="../../index.html"> Home </a>
  <a href="../../index.html#BLOG"> Blog </a>
  <a href="../../index.html#VIDEOS"> Videos </a>   
  <a href="../../research.html"> Research </a>
  <a href="../../about.html"> About </a>
  <a href="../../privacy_policy.html">Privacy Policy</a>
</div>

<font size="+2">
  <i> Bo Joel Svensson </i> <br>
  <i> blog (dot) joel (dot) svensson (at) gmail (dot) com </i> <br>
</font>

<!-- BODY IS INTENTIONALY LEFT OPEN --> 

<h1 id="audio-input-using-qt-and-qaudioinput">Audio input using Qt and QAudioInput</h1>
<p>When working on the earlier <a href="../qt_serial_datacollection/index.html">blog post</a> on serial communication with automatic data collection and plotting, I thought that maybe it would be nice to try to plot some audio waveforms as well. Now, to do that we need an audio source and I went for using a <em>QAudioInput</em> for that.</p>
<p>So, the plan for this post is to set up the following:</p>
<ul>
<li>selection of audio input device.</li>
<li>setup of sampling format and rate.</li>
<li>sampling into a <em>QBuffer</em>.</li>
<li>setting up <em>QCustomPlot</em> plot parameters.</li>
<li>plotting of sample data on the <em>QCustomPlot</em>.</li>
</ul>
<p>The GUI I made looks like below and is as usual created in the GUI Designer part of Qt Creator.</p>
<p><img src="./media/qt-sound.png" alt="waveform gui" /></p>
<p>It takes some wrestling with this GUI Designer to get a hang of it and I am not quite proficient yet (far from). The only recommendation I can give about that tool is to play with it and see what happens.</p>
<p>The GUI consists of a left hand side with a <em>QComboBox</em> for selection of audio device and a volume slider, a <em>QSlider</em>. On the right hand side there is a <em>QCustomPlot</em> as <a href="../qt_serial_datacollection/index.html">earlier</a> created by inserting a <em>QWidget</em> and then promoting in to a <em>QCustomPlot</em>.</p>
<p>The <code>Use</code> button activates the input device and starts the sampling and the <code>Refresh</code> button runs the scan for audio devices again and repopulates the <em>QComboBox</em>.</p>
<h2 id="high-level-view-of-the-program">High level view of the program</h2>
<p>The idea is to have the <em>QAudioInput</em> device generating samples into a QBuffer. Regularly, after sampling for 100ms (or some other time interval we select) we are notified that there is sample data to process in the buffer. When this notification comes, we will convert the new sample data to a format that can be plotted on the <em>QCustomPlot</em>.</p>
<p>The <em>QCustomPlot</em> will have a 2 seconds (or 96000 samples at 48KHz sampling rate) sliding window of data that it displays as a waveform.</p>
<h2 id="the-code">The Code</h2>
<p>First of all, since we are using <em>QCustomPlot</em> we are going to need <code>printsupport</code> and since we are also going to use sound devices we need to also add <code>multimedia</code> to the list of Qt modules used in the project. This can be found in the project's <code>.pro</code> file.</p>
<pre><code>QT       += core gui printsupport multimedia
</code></pre>
<p>This program does not contain a whole lot of code and all of it is implemented in <code>mainwindow.h</code> and <code>mainwindow.cpp</code>. We will start by looking at <code>mainwindow.h</code> to get a bit of an overview of what is involved.</p>
<p>First off, there are a few includes that we need for audio input, buffers and plotting.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb2-1"><a href="#cb2-1"></a><span class="pp">#include </span><span class="im">&lt;QtMultimedia/QAudioInput&gt;</span></span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="pp">#include </span><span class="im">&lt;QBuffer&gt;</span></span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="pp">#include </span><span class="im">&quot;qcustomplot.h&quot;</span></span></code></pre></div>
<p>The <em>QBuffer</em> class gives you <em>QIODevice</em> Interface to an array of storage. Another class that is also (in a number of steps) derived from <em>QIODevice</em> is <em>QFile</em>, so working with a <em>QBuffer</em> will have some similarities to working with a file.</p>
<p>The second interesting thing in <code>mainwindow.h</code> is the set of slots.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb3-1"><a href="#cb3-1"></a><span class="kw">private</span> <span class="ex">slots</span>:</span>
<span id="cb3-2"><a href="#cb3-2"></a>    <span class="dt">void</span> on_refreshInputPushButton_clicked();</span>
<span id="cb3-3"><a href="#cb3-3"></a>    <span class="dt">void</span> on_useInputPushButton_clicked();</span>
<span id="cb3-4"><a href="#cb3-4"></a></span>
<span id="cb3-5"><a href="#cb3-5"></a>    <span class="dt">void</span> processAudioIn();</span>
<span id="cb3-6"><a href="#cb3-6"></a>    <span class="dt">void</span> stateChangeAudioIn(QAudio::State s);</span>
<span id="cb3-7"><a href="#cb3-7"></a>    <span class="dt">void</span> on_volumeHorizontalSlider_sliderMoved(<span class="dt">int</span> position);</span></code></pre></div>
<p>Three of these slots, the ones starting with "on_" are related to the interactions with the buttons and slider in the GUI. The <code>processAudioIn</code> slot will be connected to a notification signal from the <em>QAudioDevice</em> so that it is called each time there is a certain amount of sample data available. The <code>stateChangeAudioIn</code> will be connected to track status changes to the audio device.</p>
<p>There is also a private function <code>void samplesUpdated();</code>, that will be called from <code>processAudioIn</code> and it will take care of updating the plot.</p>
<p>The state used in this program is next.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb4-1"><a href="#cb4-1"></a><span class="kw">private</span>:</span>
<span id="cb4-2"><a href="#cb4-2"></a>    <span class="ex">QAudioInput</span> *mAudioIn = <span class="kw">nullptr</span>;</span>
<span id="cb4-3"><a href="#cb4-3"></a>    <span class="ex">QBuffer</span>  mInputBuffer;</span>
<span id="cb4-4"><a href="#cb4-4"></a></span>
<span id="cb4-5"><a href="#cb4-5"></a>    <span class="ex">QVector</span>&lt;<span class="dt">double</span>&gt; mSamples;</span>
<span id="cb4-6"><a href="#cb4-6"></a>    <span class="ex">QVector</span>&lt;<span class="dt">double</span>&gt; mIndices;</span></code></pre></div>
<p><code>mAudioIn</code> will be our handle on the input device and <code>mInputBuffer</code> is the buffer that will receive samples from the audio device.</p>
<p><code>mSamples</code> and <code>mIndices</code> will hold the 2 second sliding window of samples that the plot is displaying. In this case we are using the <code>QVector&lt;double&gt;</code> mode of data storage as opposed to a <em>QSharedPointer</em> to <em>QCPGraphDataContainer</em> approach used in the post about <a href="../qt_serial_datacollection/index.html">serial communication</a>. As I want to add data over time to this data-set and also remove some of the old data, I thought that it would be easier with a <em>QVector</em>.</p>
<p>Below, you find the full code listing of <code>mainwindow.h</code>.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb5-1"><a href="#cb5-1"></a><span class="pp">#ifndef MAINWINDOW_H</span></span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="pp">#define MAINWINDOW_H</span></span>
<span id="cb5-3"><a href="#cb5-3"></a></span>
<span id="cb5-4"><a href="#cb5-4"></a><span class="pp">#include </span><span class="im">&lt;QMainWindow&gt;</span></span>
<span id="cb5-5"><a href="#cb5-5"></a><span class="pp">#include </span><span class="im">&lt;QtMultimedia/QAudioInput&gt;</span></span>
<span id="cb5-6"><a href="#cb5-6"></a><span class="pp">#include </span><span class="im">&lt;QBuffer&gt;</span></span>
<span id="cb5-7"><a href="#cb5-7"></a><span class="pp">#include </span><span class="im">&quot;qcustomplot.h&quot;</span></span>
<span id="cb5-8"><a href="#cb5-8"></a></span>
<span id="cb5-9"><a href="#cb5-9"></a>QT_BEGIN_NAMESPACE</span>
<span id="cb5-10"><a href="#cb5-10"></a><span class="kw">namespace</span> Ui { <span class="kw">class</span> MainWindow; }</span>
<span id="cb5-11"><a href="#cb5-11"></a>QT_END_NAMESPACE</span>
<span id="cb5-12"><a href="#cb5-12"></a></span>
<span id="cb5-13"><a href="#cb5-13"></a><span class="kw">class</span> MainWindow : <span class="kw">public</span> <span class="ex">QMainWindow</span></span>
<span id="cb5-14"><a href="#cb5-14"></a>{</span>
<span id="cb5-15"><a href="#cb5-15"></a>    <span class="ex">Q_OBJECT</span></span>
<span id="cb5-16"><a href="#cb5-16"></a></span>
<span id="cb5-17"><a href="#cb5-17"></a><span class="kw">public</span>:</span>
<span id="cb5-18"><a href="#cb5-18"></a>    MainWindow(<span class="ex">QWidget</span> *parent = <span class="kw">nullptr</span>);</span>
<span id="cb5-19"><a href="#cb5-19"></a>    ~MainWindow();</span>
<span id="cb5-20"><a href="#cb5-20"></a></span>
<span id="cb5-21"><a href="#cb5-21"></a><span class="kw">private</span> <span class="ex">slots</span>:</span>
<span id="cb5-22"><a href="#cb5-22"></a>    <span class="dt">void</span> on_refreshInputPushButton_clicked();</span>
<span id="cb5-23"><a href="#cb5-23"></a>    <span class="dt">void</span> on_useInputPushButton_clicked();</span>
<span id="cb5-24"><a href="#cb5-24"></a></span>
<span id="cb5-25"><a href="#cb5-25"></a>    <span class="dt">void</span> processAudioIn();</span>
<span id="cb5-26"><a href="#cb5-26"></a>    <span class="dt">void</span> stateChangeAudioIn(QAudio::State s);</span>
<span id="cb5-27"><a href="#cb5-27"></a>    <span class="dt">void</span> on_volumeHorizontalSlider_sliderMoved(<span class="dt">int</span> position);</span>
<span id="cb5-28"><a href="#cb5-28"></a></span>
<span id="cb5-29"><a href="#cb5-29"></a><span class="kw">private</span>:</span>
<span id="cb5-30"><a href="#cb5-30"></a>    Ui::MainWindow *ui;</span>
<span id="cb5-31"><a href="#cb5-31"></a></span>
<span id="cb5-32"><a href="#cb5-32"></a>    <span class="dt">void</span> samplesUpdated();</span>
<span id="cb5-33"><a href="#cb5-33"></a></span>
<span id="cb5-34"><a href="#cb5-34"></a>    <span class="ex">QAudioInput</span> *mAudioIn = <span class="kw">nullptr</span>;</span>
<span id="cb5-35"><a href="#cb5-35"></a>    <span class="ex">QBuffer</span>  mInputBuffer;</span>
<span id="cb5-36"><a href="#cb5-36"></a></span>
<span id="cb5-37"><a href="#cb5-37"></a>    <span class="ex">QVector</span>&lt;<span class="dt">double</span>&gt; mSamples;</span>
<span id="cb5-38"><a href="#cb5-38"></a>    <span class="ex">QVector</span>&lt;<span class="dt">double</span>&gt; mIndices;</span>
<span id="cb5-39"><a href="#cb5-39"></a></span>
<span id="cb5-40"><a href="#cb5-40"></a>};</span>
<span id="cb5-41"><a href="#cb5-41"></a><span class="pp">#endif </span><span class="co">// MAINWINDOW_H</span></span></code></pre></div>
<p>Now we can jump into <code>mainwindow.cpp</code> and break that file down. We can start with the constructor of the <code>MainWindow</code> object and look at the things are initialized in there.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb6-1"><a href="#cb6-1"></a>MainWindow::MainWindow(<span class="ex">QWidget</span> *parent)</span>
<span id="cb6-2"><a href="#cb6-2"></a>    : <span class="ex">QMainWindow</span>(parent)</span>
<span id="cb6-3"><a href="#cb6-3"></a>    , ui(<span class="kw">new</span> Ui::MainWindow)</span>
<span id="cb6-4"><a href="#cb6-4"></a>{</span>
<span id="cb6-5"><a href="#cb6-5"></a>    ui-&gt;setupUi(<span class="kw">this</span>);</span>
<span id="cb6-6"><a href="#cb6-6"></a>    <span class="kw">this</span>-&gt;setWindowTitle(<span class="st">&quot;Sound&quot;</span>);</span>
<span id="cb6-7"><a href="#cb6-7"></a></span>
<span id="cb6-8"><a href="#cb6-8"></a></span>
<span id="cb6-9"><a href="#cb6-9"></a>    <span class="ex">QList</span>&lt;<span class="ex">QAudioDeviceInfo</span>&gt; inputDevices =</span>
<span id="cb6-10"><a href="#cb6-10"></a>            <span class="ex">QAudioDeviceInfo::</span>availableDevices(QAudio::AudioInput);</span>
<span id="cb6-11"><a href="#cb6-11"></a></span>
<span id="cb6-12"><a href="#cb6-12"></a>    <span class="cf">for</span> (<span class="ex">QAudioDeviceInfo</span> d : inputDevices) {</span>
<span id="cb6-13"><a href="#cb6-13"></a>        ui-&gt;inputDeviceComboBox-&gt;addItem(d.deviceName(),<span class="ex">QVariant::</span>fromValue(d));</span>
<span id="cb6-14"><a href="#cb6-14"></a>    }</span>
<span id="cb6-15"><a href="#cb6-15"></a></span>
<span id="cb6-16"><a href="#cb6-16"></a>    <span class="co">/* Setup plot */</span></span>
<span id="cb6-17"><a href="#cb6-17"></a>    ui-&gt;plot-&gt;setInteractions(QCP::iRangeDrag | QCP::iRangeZoom);</span>
<span id="cb6-18"><a href="#cb6-18"></a>    ui-&gt;plot-&gt;legend-&gt;setVisible(<span class="kw">true</span>);</span>
<span id="cb6-19"><a href="#cb6-19"></a>    <span class="ex">QFont</span> legendFont = font();</span>
<span id="cb6-20"><a href="#cb6-20"></a>    legendFont.setPointSize(<span class="dv">10</span>);</span>
<span id="cb6-21"><a href="#cb6-21"></a>    ui-&gt;plot-&gt;legend-&gt;setFont(legendFont);</span>
<span id="cb6-22"><a href="#cb6-22"></a>    ui-&gt;plot-&gt;legend-&gt;setSelectedFont(legendFont);</span>
<span id="cb6-23"><a href="#cb6-23"></a>    ui-&gt;plot-&gt;legend-&gt;setSelectableParts(QCPLegend::spItems);</span>
<span id="cb6-24"><a href="#cb6-24"></a>    ui-&gt;plot-&gt;yAxis-&gt;setLabel(<span class="st">&quot;Amplitude&quot;</span>);</span>
<span id="cb6-25"><a href="#cb6-25"></a>    ui-&gt;plot-&gt;xAxis-&gt;setLabel(<span class="st">&quot;Sample&quot;</span>);</span>
<span id="cb6-26"><a href="#cb6-26"></a>    ui-&gt;plot-&gt;yAxis-&gt;setRange(-<span class="fl">1.0</span>, <span class="fl">1.0</span>);</span>
<span id="cb6-27"><a href="#cb6-27"></a>    ui-&gt;plot-&gt;clearGraphs();</span>
<span id="cb6-28"><a href="#cb6-28"></a>    ui-&gt;plot-&gt;addGraph();</span>
<span id="cb6-29"><a href="#cb6-29"></a></span>
<span id="cb6-30"><a href="#cb6-30"></a>    ui-&gt;plot-&gt;graph()-&gt;setPen(<span class="ex">QPen</span>(<span class="ex">Qt::</span>black));</span>
<span id="cb6-31"><a href="#cb6-31"></a>    ui-&gt;plot-&gt;graph()-&gt;setName(<span class="st">&quot;Audio In&quot;</span>);</span>
<span id="cb6-32"><a href="#cb6-32"></a></span>
<span id="cb6-33"><a href="#cb6-33"></a>    <span class="cf">for</span> (<span class="dt">int</span> i = <span class="dv">0</span>; i &lt; <span class="dv">96000</span>; i ++) {</span>
<span id="cb6-34"><a href="#cb6-34"></a>        mIndices.append((<span class="dt">double</span>)i);</span>
<span id="cb6-35"><a href="#cb6-35"></a>        mSamples.append(<span class="dv">0</span>);</span>
<span id="cb6-36"><a href="#cb6-36"></a>    }</span>
<span id="cb6-37"><a href="#cb6-37"></a></span>
<span id="cb6-38"><a href="#cb6-38"></a>}</span></code></pre></div>
<p>A list of <em>QAudioDeviceInfo</em> objects is created by asking for the <code>availableDevices</code>. The devices we are interested in are <code>AudioInput</code> devices.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb7-1"><a href="#cb7-1"></a>    <span class="ex">QList</span>&lt;<span class="ex">QAudioDeviceInfo</span>&gt; inputDevices =</span>
<span id="cb7-2"><a href="#cb7-2"></a>            <span class="ex">QAudioDeviceInfo::</span>availableDevices(QAudio::AudioInput);</span></code></pre></div>
<p>The devices in the list are then added to the <em>QComboBox</em> where the user can select which input device to use.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb8-1"><a href="#cb8-1"></a>    <span class="cf">for</span> (<span class="ex">QAudioDeviceInfo</span> d : inputDevices) {</span>
<span id="cb8-2"><a href="#cb8-2"></a>        ui-&gt;inputDeviceComboBox-&gt;addItem(d.deviceName(),<span class="ex">QVariant::</span>fromValue(d));</span>
<span id="cb8-3"><a href="#cb8-3"></a>    }</span></code></pre></div>
<p>The additional data stored in the <em>QComboBox</em> is the actual <em>QAudioDeviceInfo</em> object. So the <em>QComboBox</em> essentially implements a mapping from device names to their device info object. The <em>QAudioDeviceInfo</em> object is turned into a QVariant at this point.</p>
<p>Then the plotting parameters are configured. This is done very similarly to how it was done in the earlier <a href="../qt_serial_datacollection/index.html">text</a>.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb9-1"><a href="#cb9-1"></a>    <span class="co">/* Setup plot */</span></span>
<span id="cb9-2"><a href="#cb9-2"></a>    ui-&gt;plot-&gt;setInteractions(QCP::iRangeDrag | QCP::iRangeZoom);</span>
<span id="cb9-3"><a href="#cb9-3"></a>    ui-&gt;plot-&gt;legend-&gt;setVisible(<span class="kw">true</span>);</span>
<span id="cb9-4"><a href="#cb9-4"></a>    <span class="ex">QFont</span> legendFont = font();</span>
<span id="cb9-5"><a href="#cb9-5"></a>    legendFont.setPointSize(<span class="dv">10</span>);</span>
<span id="cb9-6"><a href="#cb9-6"></a>    ui-&gt;plot-&gt;legend-&gt;setFont(legendFont);</span>
<span id="cb9-7"><a href="#cb9-7"></a>    ui-&gt;plot-&gt;legend-&gt;setSelectedFont(legendFont);</span>
<span id="cb9-8"><a href="#cb9-8"></a>    ui-&gt;plot-&gt;legend-&gt;setSelectableParts(QCPLegend::spItems);</span>
<span id="cb9-9"><a href="#cb9-9"></a>    ui-&gt;plot-&gt;yAxis-&gt;setLabel(<span class="st">&quot;Amplitude&quot;</span>);</span>
<span id="cb9-10"><a href="#cb9-10"></a>    ui-&gt;plot-&gt;xAxis-&gt;setLabel(<span class="st">&quot;Sample&quot;</span>);</span>
<span id="cb9-11"><a href="#cb9-11"></a>    ui-&gt;plot-&gt;yAxis-&gt;setRange(-<span class="fl">1.0</span>, <span class="fl">1.0</span>);</span>
<span id="cb9-12"><a href="#cb9-12"></a>    ui-&gt;plot-&gt;clearGraphs();</span>
<span id="cb9-13"><a href="#cb9-13"></a>    ui-&gt;plot-&gt;addGraph();</span>
<span id="cb9-14"><a href="#cb9-14"></a></span>
<span id="cb9-15"><a href="#cb9-15"></a>    ui-&gt;plot-&gt;graph()-&gt;setPen(<span class="ex">QPen</span>(<span class="ex">Qt::</span>black));</span>
<span id="cb9-16"><a href="#cb9-16"></a>    ui-&gt;plot-&gt;graph()-&gt;setName(<span class="st">&quot;Audio In&quot;</span>);</span></code></pre></div>
<p>One difference is that the <code>yAxis</code> range is set to (-1.0, 1.0) and that the data-set is now called "Audio In".</p>
<p>The storage for the waveform is then initialized. There will be 96000 indices and samples as we will have a 2 seconds sliding windows at 48KHz sampling rate.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb10-1"><a href="#cb10-1"></a>    <span class="cf">for</span> (<span class="dt">int</span> i = <span class="dv">0</span>; i &lt; <span class="dv">96000</span>; i ++) {</span>
<span id="cb10-2"><a href="#cb10-2"></a>        mIndices.append((<span class="dt">double</span>)i);</span>
<span id="cb10-3"><a href="#cb10-3"></a>        mSamples.append(<span class="dv">0</span>);</span>
<span id="cb10-4"><a href="#cb10-4"></a>    }</span></code></pre></div>
<p>That is what is important in the constructor. Now we can look at the rest of the methods defined.</p>
<p>The code below is run when the <code>Refresh</code> button is clicked. This simply goes through the process of asking for available devices again and updates the contents of the <em>QComboBox</em>.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb11-1"><a href="#cb11-1"></a><span class="dt">void</span> MainWindow::on_refreshInputPushButton_clicked()</span>
<span id="cb11-2"><a href="#cb11-2"></a>{</span>
<span id="cb11-3"><a href="#cb11-3"></a>    <span class="ex">QList</span>&lt;<span class="ex">QAudioDeviceInfo</span>&gt; inputDevices =</span>
<span id="cb11-4"><a href="#cb11-4"></a>            <span class="ex">QAudioDeviceInfo::</span>availableDevices(QAudio::AudioInput);</span>
<span id="cb11-5"><a href="#cb11-5"></a></span>
<span id="cb11-6"><a href="#cb11-6"></a>    ui-&gt;inputDeviceComboBox-&gt;clear();</span>
<span id="cb11-7"><a href="#cb11-7"></a>    <span class="cf">for</span> (<span class="ex">QAudioDeviceInfo</span> d : inputDevices) {</span>
<span id="cb11-8"><a href="#cb11-8"></a>        ui-&gt;inputDeviceComboBox-&gt;addItem(d.deviceName(),<span class="ex">QVariant::</span>fromValue(d));</span>
<span id="cb11-9"><a href="#cb11-9"></a>    }</span>
<span id="cb11-10"><a href="#cb11-10"></a>}</span></code></pre></div>
<p>The next thing to look at is what happens when the <code>Use</code> button is clicked. A lot of stuff is going on here so this can take some breaking down.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb12-1"><a href="#cb12-1"></a><span class="dt">void</span> MainWindow::on_useInputPushButton_clicked()</span>
<span id="cb12-2"><a href="#cb12-2"></a>{</span>
<span id="cb12-3"><a href="#cb12-3"></a>    <span class="ex">QVariant</span> v = ui-&gt;inputDeviceComboBox-&gt;currentData();</span>
<span id="cb12-4"><a href="#cb12-4"></a>    <span class="ex">QAudioDeviceInfo</span> dev = v.value&lt;<span class="ex">QAudioDeviceInfo</span>&gt;();</span>
<span id="cb12-5"><a href="#cb12-5"></a></span>
<span id="cb12-6"><a href="#cb12-6"></a>    <span class="ex">QAudioFormat</span> format;</span>
<span id="cb12-7"><a href="#cb12-7"></a>    format.setSampleRate(<span class="dv">48000</span>);</span>
<span id="cb12-8"><a href="#cb12-8"></a>    format.setChannelCount(<span class="dv">1</span>);</span>
<span id="cb12-9"><a href="#cb12-9"></a>    format.setSampleType(<span class="ex">QAudioFormat::</span>SignedInt);</span>
<span id="cb12-10"><a href="#cb12-10"></a>    format.setCodec(<span class="st">&quot;raw&quot;</span>);</span>
<span id="cb12-11"><a href="#cb12-11"></a>    format.setSampleSize(<span class="dv">16</span>);</span>
<span id="cb12-12"><a href="#cb12-12"></a></span>
<span id="cb12-13"><a href="#cb12-13"></a>    <span class="cf">if</span> (mAudioIn) <span class="kw">delete</span> mAudioIn;</span>
<span id="cb12-14"><a href="#cb12-14"></a>    mAudioIn = <span class="kw">nullptr</span>;</span>
<span id="cb12-15"><a href="#cb12-15"></a></span>
<span id="cb12-16"><a href="#cb12-16"></a>    mAudioIn = <span class="kw">new</span> <span class="ex">QAudioInput</span>(dev,format);</span>
<span id="cb12-17"><a href="#cb12-17"></a>    mAudioIn-&gt;setVolume(<span class="fl">0.1</span>);</span>
<span id="cb12-18"><a href="#cb12-18"></a>    mAudioIn-&gt;setNotifyInterval(<span class="dv">100</span>);</span>
<span id="cb12-19"><a href="#cb12-19"></a></span>
<span id="cb12-20"><a href="#cb12-20"></a></span>
<span id="cb12-21"><a href="#cb12-21"></a>    <span class="fu">connect</span>(mAudioIn, &amp;<span class="ex">QAudioInput::</span>notify,</span>
<span id="cb12-22"><a href="#cb12-22"></a>            <span class="kw">this</span>, &amp;MainWindow::processAudioIn);</span>
<span id="cb12-23"><a href="#cb12-23"></a>    <span class="fu">connect</span>(mAudioIn, &amp;<span class="ex">QAudioInput::</span>stateChanged,</span>
<span id="cb12-24"><a href="#cb12-24"></a>            <span class="kw">this</span>, &amp;MainWindow::stateChangeAudioIn);</span>
<span id="cb12-25"><a href="#cb12-25"></a></span>
<span id="cb12-26"><a href="#cb12-26"></a>    mInputBuffer.open(<span class="ex">QBuffer::</span>ReadWrite);</span>
<span id="cb12-27"><a href="#cb12-27"></a>    mAudioIn-&gt;start(&amp;mInputBuffer);</span>
<span id="cb12-28"><a href="#cb12-28"></a>}</span></code></pre></div>
<p>First we look up in the <em>QComboBox</em> which device is selected.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb13-1"><a href="#cb13-1"></a>    <span class="ex">QVariant</span> v = ui-&gt;inputDeviceComboBox-&gt;currentData();</span>
<span id="cb13-2"><a href="#cb13-2"></a>    <span class="ex">QAudioDeviceInfo</span> dev = v.value&lt;<span class="ex">QAudioDeviceInfo</span>&gt;();</span></code></pre></div>
<p>Then a sample format is specified.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb14-1"><a href="#cb14-1"></a>    <span class="ex">QAudioFormat</span> format;</span>
<span id="cb14-2"><a href="#cb14-2"></a>    format.setSampleRate(<span class="dv">48000</span>);</span>
<span id="cb14-3"><a href="#cb14-3"></a>    format.setChannelCount(<span class="dv">1</span>);</span>
<span id="cb14-4"><a href="#cb14-4"></a>    format.setSampleType(<span class="ex">QAudioFormat::</span>SignedInt);</span>
<span id="cb14-5"><a href="#cb14-5"></a>    format.setCodec(<span class="st">&quot;raw&quot;</span>);</span>
<span id="cb14-6"><a href="#cb14-6"></a>    format.setSampleSize(<span class="dv">16</span>);</span></code></pre></div>
<p>The parameters above seem to work well with my Blue Snowball microphone under Linux. The parameters are hard coded here but could of course have been exposed to the user via the GUI.</p>
<p>Next check if the audio input device has already been created (by a previous click on the button) and in that case remove that device.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb15-1"><a href="#cb15-1"></a>    <span class="cf">if</span> (mAudioIn) <span class="kw">delete</span> mAudioIn;</span>
<span id="cb15-2"><a href="#cb15-2"></a>    mAudioIn = <span class="kw">nullptr</span>;</span></code></pre></div>
<p>Then we can set up a new input device.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb16-1"><a href="#cb16-1"></a>    mAudioIn = <span class="kw">new</span> <span class="ex">QAudioInput</span>(dev,format);</span>
<span id="cb16-2"><a href="#cb16-2"></a>    mAudioIn-&gt;setVolume(<span class="fl">0.1</span>);</span>
<span id="cb16-3"><a href="#cb16-3"></a>    mAudioIn-&gt;setNotifyInterval(<span class="dv">100</span>);</span></code></pre></div>
<p>Here we make use of the sample format specified earlier. The volume of the device is initially set to a low value. Volume is a value between 0 and 1. A notification interval is set to 100ms and this means that a notify signal will be triggered every 100ms.</p>
<p>There are two signals from the audio device that we will connect.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb17-1"><a href="#cb17-1"></a>    <span class="fu">connect</span>(mAudioIn, &amp;<span class="ex">QAudioInput::</span>notify,</span>
<span id="cb17-2"><a href="#cb17-2"></a>            <span class="kw">this</span>, &amp;MainWindow::processAudioIn);</span>
<span id="cb17-3"><a href="#cb17-3"></a>    <span class="fu">connect</span>(mAudioIn, &amp;<span class="ex">QAudioInput::</span>stateChanged,</span>
<span id="cb17-4"><a href="#cb17-4"></a>            <span class="kw">this</span>, &amp;MainWindow::stateChangeAudioIn);</span></code></pre></div>
<p>The first of these are the notify signal as mentioned above. <code>notify</code> is here connected to <code>processAudioIn</code>. The <code>stateChanged</code> signal is connected to slot <code>stateChangeAudioIn</code>. Currently the program is not doing any real work in relation to this signal, it just prints a message.</p>
<p>Lastly the <em>QBuffer</em> is opened for reading and writing and the audio device is started.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb18-1"><a href="#cb18-1"></a>    mInputBuffer.open(<span class="ex">QBuffer::</span>ReadWrite);</span>
<span id="cb18-2"><a href="#cb18-2"></a>    mAudioIn-&gt;start(&amp;mInputBuffer);</span></code></pre></div>
<p>Once the device is started it will start producing samples.</p>
<p>When enough samples have been written (100ms worth of samples), the <code>notify</code> signal goes off and <code>processAudioIn</code> is executed.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb19-1"><a href="#cb19-1"></a><span class="dt">void</span> MainWindow::processAudioIn()</span>
<span id="cb19-2"><a href="#cb19-2"></a>{</span>
<span id="cb19-3"><a href="#cb19-3"></a>    mInputBuffer.seek(<span class="dv">0</span>);</span>
<span id="cb19-4"><a href="#cb19-4"></a>    <span class="ex">QByteArray</span> ba = mInputBuffer.readAll();</span>
<span id="cb19-5"><a href="#cb19-5"></a></span>
<span id="cb19-6"><a href="#cb19-6"></a>    <span class="dt">int</span> num_samples = ba.length() / <span class="dv">2</span>;</span>
<span id="cb19-7"><a href="#cb19-7"></a>    <span class="dt">int</span> b_pos = <span class="dv">0</span>;</span>
<span id="cb19-8"><a href="#cb19-8"></a>    <span class="cf">for</span> (<span class="dt">int</span> i = <span class="dv">0</span>; i &lt; num_samples; i ++) {</span>
<span id="cb19-9"><a href="#cb19-9"></a>        <span class="dt">int16_t</span> s;</span>
<span id="cb19-10"><a href="#cb19-10"></a>        s = ba.at(b_pos++);</span>
<span id="cb19-11"><a href="#cb19-11"></a>        s |= ba.at(b_pos++) &lt;&lt; <span class="dv">8</span>;</span>
<span id="cb19-12"><a href="#cb19-12"></a>        <span class="cf">if</span> (s != <span class="dv">0</span>) {</span>
<span id="cb19-13"><a href="#cb19-13"></a>            mSamples.append((<span class="dt">double</span>)s / <span class="fl">32768.0</span>);</span>
<span id="cb19-14"><a href="#cb19-14"></a>        } <span class="cf">else</span> {</span>
<span id="cb19-15"><a href="#cb19-15"></a>            mSamples.append(<span class="dv">0</span>);</span>
<span id="cb19-16"><a href="#cb19-16"></a>        }</span>
<span id="cb19-17"><a href="#cb19-17"></a>    }</span>
<span id="cb19-18"><a href="#cb19-18"></a>    mInputBuffer.buffer().clear();</span>
<span id="cb19-19"><a href="#cb19-19"></a>    mInputBuffer.seek(<span class="dv">0</span>);</span>
<span id="cb19-20"><a href="#cb19-20"></a></span>
<span id="cb19-21"><a href="#cb19-21"></a>    samplesUpdated();</span>
<span id="cb19-22"><a href="#cb19-22"></a>}</span></code></pre></div>
<p>We now want to read out all data from the <em>QBuffer</em> and populate the <code>mSamples</code> vector with values. The data read from the <em>QBuffer</em> are raw bytes, but we have specified 16 bit samples so to create one value for <code>mSamples</code> two values from the <em>QBuffer</em> will be used. these are combined into one 16 bit value and then converted into a double between 0 and 1.</p>
<p>When that is done the <em>QBuffer</em> is cleared.</p>
<p>The calls to <code>seek(0)</code> rewinds the "position"-marker associated with the <em>QBuffer</em>. The position-marker is the place at where reading or writing to the buffer takes place.</p>
<p>Control is then passed over to the <code>samplesUpdated</code> function that handles the sliding window of samples used to display the waveform.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb20-1"><a href="#cb20-1"></a><span class="dt">void</span> MainWindow::samplesUpdated()</span>
<span id="cb20-2"><a href="#cb20-2"></a>{</span>
<span id="cb20-3"><a href="#cb20-3"></a>    <span class="dt">int</span> n = mSamples.length();</span>
<span id="cb20-4"><a href="#cb20-4"></a>    <span class="cf">if</span> (n &gt; <span class="dv">96000</span>) mSamples = mSamples.mid(n - <span class="dv">96000</span>,-<span class="dv">1</span>);</span>
<span id="cb20-5"><a href="#cb20-5"></a></span>
<span id="cb20-6"><a href="#cb20-6"></a>    ui-&gt;plot-&gt;graph(<span class="dv">0</span>)-&gt;setData(mIndices,mSamples);</span>
<span id="cb20-7"><a href="#cb20-7"></a>    ui-&gt;plot-&gt;xAxis-&gt;rescale();</span>
<span id="cb20-8"><a href="#cb20-8"></a>    ui-&gt;plot-&gt;replot();</span>
<span id="cb20-9"><a href="#cb20-9"></a>}</span></code></pre></div>
<p>If there are more than 96000 samples in <code>mSamples</code> enough samples are removed from the beginning of the vector so that there are only 96000 left. Older data is towards the front of this vector. The <code>mid</code> method on <em>QVector</em> takes two arguments, a starting index and a final index. The elements of the <em>QVector</em> that are outside of this range (from start to end) is removed. Using -1 as the end index means "to the end". So we are asking to to keep all elements from index <code>n - 96000</code> to the end of the <em>QVector</em>.</p>
<p>The samples are then handed over to <em>QCustomPlot</em> for display.</p>
<p>Now there are only two things left to mention and that is the volume slider and the state change slot. These are not very tricky.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb21-1"><a href="#cb21-1"></a><span class="dt">void</span> MainWindow::stateChangeAudioIn(QAudio::State s)</span>
<span id="cb21-2"><a href="#cb21-2"></a>{</span>
<span id="cb21-3"><a href="#cb21-3"></a>    <span class="fu">qDebug</span>() &lt;&lt; <span class="st">&quot;State change: &quot;</span> &lt;&lt; s;</span>
<span id="cb21-4"><a href="#cb21-4"></a>}</span>
<span id="cb21-5"><a href="#cb21-5"></a></span>
<span id="cb21-6"><a href="#cb21-6"></a><span class="dt">void</span> MainWindow::on_volumeHorizontalSlider_sliderMoved(<span class="dt">int</span> position)</span>
<span id="cb21-7"><a href="#cb21-7"></a>{</span>
<span id="cb21-8"><a href="#cb21-8"></a>    <span class="cf">if</span> (mAudioIn) {</span>
<span id="cb21-9"><a href="#cb21-9"></a>        mAudioIn-&gt;setVolume((<span class="dt">double</span>)position/<span class="fl">1000.0</span>);</span>
<span id="cb21-10"><a href="#cb21-10"></a>    }</span>
<span id="cb21-11"><a href="#cb21-11"></a>}</span></code></pre></div>
<p>When there is a state change in the audio device a debug message is printed. In a more complex setup, I am sure we could come up with more useful ways to handle the knowledge that the state changed and in what way it changed.</p>
<p>The slider has been set up to provide values between 0 and 1000 as it slides from left to right. The rightmost position means maximum value and should correspond to a value of 1.0 being used in the <code>setVolume</code> call.</p>
<p>And now the complete <code>mainwindow.cpp</code> follows.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb22-1"><a href="#cb22-1"></a><span class="pp">#include </span><span class="im">&quot;mainwindow.h&quot;</span></span>
<span id="cb22-2"><a href="#cb22-2"></a><span class="pp">#include </span><span class="im">&quot;ui_mainwindow.h&quot;</span></span>
<span id="cb22-3"><a href="#cb22-3"></a><span class="pp">#include </span><span class="im">&lt;QDebug&gt;</span></span>
<span id="cb22-4"><a href="#cb22-4"></a></span>
<span id="cb22-5"><a href="#cb22-5"></a>MainWindow::MainWindow(<span class="ex">QWidget</span> *parent)</span>
<span id="cb22-6"><a href="#cb22-6"></a>    : <span class="ex">QMainWindow</span>(parent)</span>
<span id="cb22-7"><a href="#cb22-7"></a>    , ui(<span class="kw">new</span> Ui::MainWindow)</span>
<span id="cb22-8"><a href="#cb22-8"></a>{</span>
<span id="cb22-9"><a href="#cb22-9"></a>    ui-&gt;setupUi(<span class="kw">this</span>);</span>
<span id="cb22-10"><a href="#cb22-10"></a>    <span class="kw">this</span>-&gt;setWindowTitle(<span class="st">&quot;Sound&quot;</span>);</span>
<span id="cb22-11"><a href="#cb22-11"></a></span>
<span id="cb22-12"><a href="#cb22-12"></a></span>
<span id="cb22-13"><a href="#cb22-13"></a>    <span class="ex">QList</span>&lt;<span class="ex">QAudioDeviceInfo</span>&gt; inputDevices =</span>
<span id="cb22-14"><a href="#cb22-14"></a>            <span class="ex">QAudioDeviceInfo::</span>availableDevices(QAudio::AudioInput);</span>
<span id="cb22-15"><a href="#cb22-15"></a></span>
<span id="cb22-16"><a href="#cb22-16"></a>    <span class="cf">for</span> (<span class="ex">QAudioDeviceInfo</span> d : inputDevices) {</span>
<span id="cb22-17"><a href="#cb22-17"></a>        ui-&gt;inputDeviceComboBox-&gt;addItem(d.deviceName(),<span class="ex">QVariant::</span>fromValue(d));</span>
<span id="cb22-18"><a href="#cb22-18"></a>    }</span>
<span id="cb22-19"><a href="#cb22-19"></a></span>
<span id="cb22-20"><a href="#cb22-20"></a>    <span class="co">/* Setup plot */</span></span>
<span id="cb22-21"><a href="#cb22-21"></a>    ui-&gt;plot-&gt;setInteractions(QCP::iRangeDrag | QCP::iRangeZoom);</span>
<span id="cb22-22"><a href="#cb22-22"></a>    ui-&gt;plot-&gt;legend-&gt;setVisible(<span class="kw">true</span>);</span>
<span id="cb22-23"><a href="#cb22-23"></a>    <span class="ex">QFont</span> legendFont = font();</span>
<span id="cb22-24"><a href="#cb22-24"></a>    legendFont.setPointSize(<span class="dv">10</span>);</span>
<span id="cb22-25"><a href="#cb22-25"></a>    ui-&gt;plot-&gt;legend-&gt;setFont(legendFont);</span>
<span id="cb22-26"><a href="#cb22-26"></a>    ui-&gt;plot-&gt;legend-&gt;setSelectedFont(legendFont);</span>
<span id="cb22-27"><a href="#cb22-27"></a>    ui-&gt;plot-&gt;legend-&gt;setSelectableParts(QCPLegend::spItems);</span>
<span id="cb22-28"><a href="#cb22-28"></a>    ui-&gt;plot-&gt;yAxis-&gt;setLabel(<span class="st">&quot;Amplitude&quot;</span>);</span>
<span id="cb22-29"><a href="#cb22-29"></a>    ui-&gt;plot-&gt;xAxis-&gt;setLabel(<span class="st">&quot;Sample&quot;</span>);</span>
<span id="cb22-30"><a href="#cb22-30"></a>    ui-&gt;plot-&gt;yAxis-&gt;setRange(-<span class="fl">1.0</span>, <span class="fl">1.0</span>);</span>
<span id="cb22-31"><a href="#cb22-31"></a>    ui-&gt;plot-&gt;clearGraphs();</span>
<span id="cb22-32"><a href="#cb22-32"></a>    ui-&gt;plot-&gt;addGraph();</span>
<span id="cb22-33"><a href="#cb22-33"></a></span>
<span id="cb22-34"><a href="#cb22-34"></a>    ui-&gt;plot-&gt;graph()-&gt;setPen(<span class="ex">QPen</span>(<span class="ex">Qt::</span>black));</span>
<span id="cb22-35"><a href="#cb22-35"></a>    ui-&gt;plot-&gt;graph()-&gt;setName(<span class="st">&quot;Audio In&quot;</span>);</span>
<span id="cb22-36"><a href="#cb22-36"></a></span>
<span id="cb22-37"><a href="#cb22-37"></a>    <span class="cf">for</span> (<span class="dt">int</span> i = <span class="dv">0</span>; i &lt; <span class="dv">96000</span>; i ++) {</span>
<span id="cb22-38"><a href="#cb22-38"></a>        mIndices.append((<span class="dt">double</span>)i);</span>
<span id="cb22-39"><a href="#cb22-39"></a>        mSamples.append(<span class="dv">0</span>);</span>
<span id="cb22-40"><a href="#cb22-40"></a>    }</span>
<span id="cb22-41"><a href="#cb22-41"></a></span>
<span id="cb22-42"><a href="#cb22-42"></a>}</span>
<span id="cb22-43"><a href="#cb22-43"></a></span>
<span id="cb22-44"><a href="#cb22-44"></a>MainWindow::~MainWindow()</span>
<span id="cb22-45"><a href="#cb22-45"></a>{</span>
<span id="cb22-46"><a href="#cb22-46"></a>    <span class="kw">delete</span> ui;</span>
<span id="cb22-47"><a href="#cb22-47"></a>}</span>
<span id="cb22-48"><a href="#cb22-48"></a></span>
<span id="cb22-49"><a href="#cb22-49"></a></span>
<span id="cb22-50"><a href="#cb22-50"></a><span class="dt">void</span> MainWindow::on_refreshInputPushButton_clicked()</span>
<span id="cb22-51"><a href="#cb22-51"></a>{</span>
<span id="cb22-52"><a href="#cb22-52"></a>    <span class="ex">QList</span>&lt;<span class="ex">QAudioDeviceInfo</span>&gt; inputDevices =</span>
<span id="cb22-53"><a href="#cb22-53"></a>            <span class="ex">QAudioDeviceInfo::</span>availableDevices(QAudio::AudioInput);</span>
<span id="cb22-54"><a href="#cb22-54"></a></span>
<span id="cb22-55"><a href="#cb22-55"></a>    ui-&gt;inputDeviceComboBox-&gt;clear();</span>
<span id="cb22-56"><a href="#cb22-56"></a>    <span class="cf">for</span> (<span class="ex">QAudioDeviceInfo</span> d : inputDevices) {</span>
<span id="cb22-57"><a href="#cb22-57"></a>        ui-&gt;inputDeviceComboBox-&gt;addItem(d.deviceName(),<span class="ex">QVariant::</span>fromValue(d));</span>
<span id="cb22-58"><a href="#cb22-58"></a>    }</span>
<span id="cb22-59"><a href="#cb22-59"></a>}</span>
<span id="cb22-60"><a href="#cb22-60"></a></span>
<span id="cb22-61"><a href="#cb22-61"></a><span class="dt">void</span> MainWindow::on_useInputPushButton_clicked()</span>
<span id="cb22-62"><a href="#cb22-62"></a>{</span>
<span id="cb22-63"><a href="#cb22-63"></a>    <span class="ex">QVariant</span> v = ui-&gt;inputDeviceComboBox-&gt;currentData();</span>
<span id="cb22-64"><a href="#cb22-64"></a>    <span class="ex">QAudioDeviceInfo</span> dev = v.value&lt;<span class="ex">QAudioDeviceInfo</span>&gt;();</span>
<span id="cb22-65"><a href="#cb22-65"></a></span>
<span id="cb22-66"><a href="#cb22-66"></a>    <span class="ex">QAudioFormat</span> format;</span>
<span id="cb22-67"><a href="#cb22-67"></a>    format.setSampleRate(<span class="dv">48000</span>);</span>
<span id="cb22-68"><a href="#cb22-68"></a>    format.setChannelCount(<span class="dv">1</span>);</span>
<span id="cb22-69"><a href="#cb22-69"></a>    format.setSampleType(<span class="ex">QAudioFormat::</span>SignedInt);</span>
<span id="cb22-70"><a href="#cb22-70"></a>    format.setCodec(<span class="st">&quot;raw&quot;</span>);</span>
<span id="cb22-71"><a href="#cb22-71"></a>    format.setSampleSize(<span class="dv">16</span>);</span>
<span id="cb22-72"><a href="#cb22-72"></a></span>
<span id="cb22-73"><a href="#cb22-73"></a>    <span class="cf">if</span> (mAudioIn) <span class="kw">delete</span> mAudioIn;</span>
<span id="cb22-74"><a href="#cb22-74"></a>    mAudioIn = <span class="kw">nullptr</span>;</span>
<span id="cb22-75"><a href="#cb22-75"></a></span>
<span id="cb22-76"><a href="#cb22-76"></a>    mAudioIn = <span class="kw">new</span> <span class="ex">QAudioInput</span>(dev,format);</span>
<span id="cb22-77"><a href="#cb22-77"></a>    mAudioIn-&gt;setVolume(<span class="fl">0.1</span>);</span>
<span id="cb22-78"><a href="#cb22-78"></a>    mAudioIn-&gt;setNotifyInterval(<span class="dv">100</span>);</span>
<span id="cb22-79"><a href="#cb22-79"></a></span>
<span id="cb22-80"><a href="#cb22-80"></a></span>
<span id="cb22-81"><a href="#cb22-81"></a>    <span class="fu">connect</span>(mAudioIn, &amp;<span class="ex">QAudioInput::</span>notify,</span>
<span id="cb22-82"><a href="#cb22-82"></a>            <span class="kw">this</span>, &amp;MainWindow::processAudioIn);</span>
<span id="cb22-83"><a href="#cb22-83"></a>    <span class="fu">connect</span>(mAudioIn, &amp;<span class="ex">QAudioInput::</span>stateChanged,</span>
<span id="cb22-84"><a href="#cb22-84"></a>            <span class="kw">this</span>, &amp;MainWindow::stateChangeAudioIn);</span>
<span id="cb22-85"><a href="#cb22-85"></a></span>
<span id="cb22-86"><a href="#cb22-86"></a>    mInputBuffer.open(<span class="ex">QBuffer::</span>ReadWrite);</span>
<span id="cb22-87"><a href="#cb22-87"></a>    mAudioIn-&gt;start(&amp;mInputBuffer);</span>
<span id="cb22-88"><a href="#cb22-88"></a>}</span>
<span id="cb22-89"><a href="#cb22-89"></a></span>
<span id="cb22-90"><a href="#cb22-90"></a><span class="dt">void</span> MainWindow::processAudioIn()</span>
<span id="cb22-91"><a href="#cb22-91"></a>{</span>
<span id="cb22-92"><a href="#cb22-92"></a>    mInputBuffer.seek(<span class="dv">0</span>);</span>
<span id="cb22-93"><a href="#cb22-93"></a>    <span class="ex">QByteArray</span> ba = mInputBuffer.readAll();</span>
<span id="cb22-94"><a href="#cb22-94"></a></span>
<span id="cb22-95"><a href="#cb22-95"></a>    <span class="dt">int</span> num_samples = ba.length() / <span class="dv">2</span>;</span>
<span id="cb22-96"><a href="#cb22-96"></a>    <span class="dt">int</span> b_pos = <span class="dv">0</span>;</span>
<span id="cb22-97"><a href="#cb22-97"></a>    <span class="cf">for</span> (<span class="dt">int</span> i = <span class="dv">0</span>; i &lt; num_samples; i ++) {</span>
<span id="cb22-98"><a href="#cb22-98"></a>        <span class="dt">int16_t</span> s;</span>
<span id="cb22-99"><a href="#cb22-99"></a>        s = ba.at(b_pos++);</span>
<span id="cb22-100"><a href="#cb22-100"></a>        s |= ba.at(b_pos++) &lt;&lt; <span class="dv">8</span>;</span>
<span id="cb22-101"><a href="#cb22-101"></a>        <span class="cf">if</span> (s != <span class="dv">0</span>) {</span>
<span id="cb22-102"><a href="#cb22-102"></a>            mSamples.append((<span class="dt">double</span>)s / <span class="fl">32768.0</span>);</span>
<span id="cb22-103"><a href="#cb22-103"></a>        } <span class="cf">else</span> {</span>
<span id="cb22-104"><a href="#cb22-104"></a>            mSamples.append(<span class="dv">0</span>);</span>
<span id="cb22-105"><a href="#cb22-105"></a>        }</span>
<span id="cb22-106"><a href="#cb22-106"></a>    }</span>
<span id="cb22-107"><a href="#cb22-107"></a>    mInputBuffer.buffer().clear();</span>
<span id="cb22-108"><a href="#cb22-108"></a>    mInputBuffer.seek(<span class="dv">0</span>);</span>
<span id="cb22-109"><a href="#cb22-109"></a></span>
<span id="cb22-110"><a href="#cb22-110"></a>    samplesUpdated();</span>
<span id="cb22-111"><a href="#cb22-111"></a>}</span>
<span id="cb22-112"><a href="#cb22-112"></a></span>
<span id="cb22-113"><a href="#cb22-113"></a><span class="dt">void</span> MainWindow::stateChangeAudioIn(QAudio::State s)</span>
<span id="cb22-114"><a href="#cb22-114"></a>{</span>
<span id="cb22-115"><a href="#cb22-115"></a>    <span class="fu">qDebug</span>() &lt;&lt; <span class="st">&quot;State change: &quot;</span> &lt;&lt; s;</span>
<span id="cb22-116"><a href="#cb22-116"></a>}</span>
<span id="cb22-117"><a href="#cb22-117"></a></span>
<span id="cb22-118"><a href="#cb22-118"></a><span class="dt">void</span> MainWindow::on_volumeHorizontalSlider_sliderMoved(<span class="dt">int</span> position)</span>
<span id="cb22-119"><a href="#cb22-119"></a>{</span>
<span id="cb22-120"><a href="#cb22-120"></a>    <span class="cf">if</span> (mAudioIn) {</span>
<span id="cb22-121"><a href="#cb22-121"></a>        mAudioIn-&gt;setVolume((<span class="dt">double</span>)position/<span class="fl">1000.0</span>);</span>
<span id="cb22-122"><a href="#cb22-122"></a>    }</span>
<span id="cb22-123"><a href="#cb22-123"></a>}</span>
<span id="cb22-124"><a href="#cb22-124"></a></span>
<span id="cb22-125"><a href="#cb22-125"></a><span class="dt">void</span> MainWindow::samplesUpdated()</span>
<span id="cb22-126"><a href="#cb22-126"></a>{</span>
<span id="cb22-127"><a href="#cb22-127"></a>    <span class="dt">int</span> n = mSamples.length();</span>
<span id="cb22-128"><a href="#cb22-128"></a>    <span class="cf">if</span> (n &gt; <span class="dv">96000</span>) mSamples = mSamples.mid(n - <span class="dv">96000</span>,-<span class="dv">1</span>);</span>
<span id="cb22-129"><a href="#cb22-129"></a></span>
<span id="cb22-130"><a href="#cb22-130"></a>    ui-&gt;plot-&gt;graph(<span class="dv">0</span>)-&gt;setData(mIndices,mSamples);</span>
<span id="cb22-131"><a href="#cb22-131"></a>    ui-&gt;plot-&gt;xAxis-&gt;rescale();</span>
<span id="cb22-132"><a href="#cb22-132"></a>    ui-&gt;plot-&gt;replot();</span>
<span id="cb22-133"><a href="#cb22-133"></a>}</span></code></pre></div>
<h1 id="wrap-up">Wrap up</h1>
<p>Ok, that was a small program for audio input. Maybe it can be useful for someone as a base of something fun.</p>
<p>Thanks for reading, I hope you enjoyed it. I would be grateful for any and all feedback you may have. I am not a Qt expert at all and may be doing things here that are very not-the-Qt-way. If that is the case, please let me know.</p>
<hr />
<p><a href="https://svenssonjoel.github.io">HOME</a></p>
<p>Please contact me with questions, suggestions or feedback at blog (dot) joel (dot) svensson (at) gmail (dot) com or join the <a href=https://groups.google.com/g/svenssonjoelgithubio> google group </a>.</p>
<p> Copyright 2020 Bo Joel Svensson</p>
<p>This page was generated using <a href=https://pandoc.org/> Pandoc</a>.</p>
</BODY>
</HTML>
